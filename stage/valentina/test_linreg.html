<!doctype html>
<html>

<head>
  <title>Regression</title>
<link href="stile.css" rel="stylesheet" type="text/css">
</head>

<body>
<h1>Regressione: Lineare, Esponenziale, Polinomiale (dal 2 a 5 grado) e Knn</h1>

<div id=big_container>
<span id=grafico>
  <canvas id="NPGcanvas" width="700" height="650" onclick="eventClick(event)">Browser not supported for Canvas. Get a real browser.</canvas>
</span>

<span id=destra>
<p>Select your algorithms:</p>
<div id="algo">
<input id="button_reg" type="button" value="Linear" onclick="setLearner(0)">
<input id="button_exp" type="button" value="Exp" onclick="setLearner(1)">
<input id="button_par" type="button" value="Square" onclick="setLearner(2)">
<input id="button_pol3" type="button" value="Cube" onclick="setLearner(3)">
<input id="button_pol4" type="button" value="Pol4" onclick="setLearner(4)">
<input id="button_pol5" type="button" value="Pol5" onclick="setLearner(5)">
<input id="button_knn" type="button" value="knn" onclick="setLearner(6)"> 
</div>

<p>Select your actions:</p>
<div id="azioni">
<input id="button_train" type="button" value="Train" onclick="train()">
<input id="button_sql" type="button" value="Sql" onclick="sql()">
<input id="button_rse" type="button" value="RSE" onclick="rse()">
<input id="button_rss" type="button" value="RSS" onclick="rss()">
<input id="button_mse" type="button" value="MSE" onclick="mse()">
<input id="button_r2" type="button" value="R2" onclick="r2()">
<input id="button_r2Aj" type="button" value="R2 Adjusted" onclick="r2_adjusted()">
<input id="button_F" type="button" value="Statistica F" onclick="statistica_F()">
<input id="button_var" type="button" value="Varianza" onclick = "varianza()">
<input id="button_cov" type="button" value="Covarianza" onclick = "covarianza()">
</div>

<div id="result">
<div id="info"></div>
<div id="sql"></div>
<div id="rse"></div>
<div id="rss"></div>
<div id="mse"></div>
<div id="r2"></div>
<div id="r2_adjusted"></div>
<div id="statistica_F"></div>
<div id="varianza"></div>
<div id="covarianza"></div>

</div></span>
<input id="button_show" type="button" value="Dettagli" onclick = "show()">
<input id="button_clean" type="submit" value="Clean Desk" onclick="cleanGrafico()">
<div id="clean"></div>
<div id="show"></div>
</div>

<script src="ZMLBase.js"></script>
<script src="LinearRegression.js"></script>
<script src="ZMLLinearRegression.js"></script>

<script>
// variabili per la gestione del canvas
var canvas = document.getElementById("NPGcanvas")
var ctx = canvas.getContext('2d');
var WIDTH=700,HEIGHT=650,ss=50.0

// variabili per il learner
var data=[];               // valori delle x dei punti disegnati
var values=[];               // valori delle y dei punti disegnati           
var trained=false;

var learners=[new LinearRegressionLearner(1), new ExpRegressionLearner(1),
              new PolinomialRegressionLearner(2), new PolinomialRegressionLearner(3), new PolinomialRegressionLearner(4), 
              new PolinomialRegressionLearner(5), new knnRegressionLearner(8)]
var lrn=learners[0]
var mdl=null

function addDataPoint(x,y,c){
  // add datapoint at location of click
  data.push([(x-WIDTH/2)/ss]);
  values.push(-(y-HEIGHT/2)/ss);
  trained=false
  Redraw()
}

function mouseClick(x,y,shift){
  addDataPoint(x,y,(shift?1:-1))
}

function eventClick(e) {    
  //get position of cursor relative to top left of canvas
  var x = e.pageX;
  var y = e.pageY;
  var r = canvas.getBoundingClientRect();
  x -= r.left+window.scrollX;
  y -= r.top+window.scrollY;  
  //call user-defined callback
  mouseClick(x, y, e.shiftKey);
}

function drawCircle(x, y, r){
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI*2, true); 
  ctx.closePath();
  ctx.stroke();
  ctx.fill();
}

function Redraw(){
  ctx.clearRect(0,0,WIDTH,HEIGHT);
      
  if (trained) {    
    var density= 4.0;
    ctx.beginPath();
    ctx.strokeStyle = 'rgb(236, 42, 107)';
    ctx.moveTo(0-density/2,(-mdl.predictJS([(0-WIDTH/2)/ss])*ss+HEIGHT/2)-density);
    for(var x=0.0; x<=WIDTH; x+= density){
      var p=-mdl.predictJS([(x-WIDTH/2)/ss])
      ctx.lineTo(x-density/2, (p*ss+HEIGHT/2)-density);
      //ctx.fillStyle = 'rgb(0,0,0)'
      //ctx.fillRect(x-density/2, (p*ss+HEIGHT/2)-density, 2, 2);
    }    
    ctx.stroke();
  }
  // draw axes
  ctx.beginPath();
  ctx.strokeStyle = 'rgb(50,50,50)';
  ctx.lineWidth = 1;
  ctx.moveTo(0, HEIGHT/2);
  ctx.lineTo(WIDTH, HEIGHT/2);
  ctx.moveTo(WIDTH/2, 0);
  ctx.lineTo(WIDTH/2, HEIGHT);
  ctx.stroke();
  // draw data points
  ctx.fillStyle = 'rgb(150,250,150)'
  for(var i=0;i<data.length;i++){
    //ctx.fillStyle = (labels[i]==1?'rgb(100,200,100)':'rgb(200,100,100)');
    drawCircle(data[i][0]*ss+WIDTH/2, -values[i]*ss+HEIGHT/2, 3);
  }
}

function cleanGrafico(){
  document.getElementById("clean").innerHTML = "<b>Press f5 and retrain your model :-)</b>"; 

}

Redraw()

function train(){
  lrn.resetData()
  for(var i=0;i<data.length;i++){
    lrn.addData(values[i],data[i])
  }
  lrn.train()
  mdl=lrn.getModel()
  trained=true
  Redraw()
}

function sql(){
  if (trained){
    document.getElementById("sql").innerHTML="<b>SQL =</b> "+mdl.predictSQL(['CampoA'])
  }

  else show();
}

function r2(){

  if(!trained)
    show();

  else{
    var sum=0,n=values.length,i
  // calcolo la media, che Ã¨ il miglior predittore quando ho solo i valori
    for(i=0;i<n;i++) 
      sum+=values[i]
    var mean=sum/n
  // calcolo la somma dei quadrati delle differenze rispetto alla media, questo mi da una misura di quanto sbaglio usando la media come predittore
    var m_error=0
    for(i=0;i<n;i++)
      m_error+= Math.pow(values[i]-mean,2)
    // nella variabile m_error la somma degli errori rispetto alla media
    // calcolo quanto sbaglio usando il mio sistema di regressione
    var p_error=0
    for(i=0;i<n;i++)
      p_error+=Math.pow(values[i]-mdl.predictJS(data[i]),2)
    // nella variabile p_error la somma degli errori rispetto al mio regressore
    var r2=1-(p_error/m_error)
    document.getElementById("r2").innerHTML="<b>R2 =</b> "+r2
    return r2
  }
}

function r2_adjusted(){

  if(!trained)
    show();

  else{
    var R2 = r2();
    var p = lrn.getNumberOfPredictors(), n = values.length;
    var r2_aj = R2 - [(1-R2) / p/(n-p-1)];

   document.getElementById("r2_adjusted").innerHTML="<b>R2 Adjusted =</b> "+r2_aj;
  }
}

function rse(){ //sum sqrt [(yi - yi_pred)^2 /n-2]

  if(!trained)
    show();

  else{
    var n = values.length;
    var p_error=0;

    for(i = 0; i < n; i++)
      p_error =+ Math.pow(values[i]-mdl.predictJS(data[i]),2)

    var rse = Math.sqrt(p_error / (n-2));
    document.getElementById("rse").innerHTML = "<b>Residual Standard Error =</b> "+ rse; 
   return rse;
  }
}

function rss(){

  if(!trained)
    show();

    else{
    var RSE = rse();
    n = data.length;

    var rss = Math.sqrt(RSE, 2) * (n - 2);
    document.getElementById("rss").innerHTML = "<b>Residual Sum of Square =</b> "+ rss; 
    return rss;
  }
}

function mse(){

  if(!trained)
    show();

  else{
    var RSS = rss();
    n = data.length;

    var mse = (1 / n) * RSS;
    document.getElementById("mse").innerHTML = "<b>Mean squared error =</b> "+ mse; 
  }
}

function statistica_F(){

  if(!trained)
    show();

    else{
      var R2 = r2();
    var p = lrn.getNumberOfPredictors(), n = values.length;

    var F1 = R2 / (1 - R2);
    var F2 = (n - p - 1) / p;

    F_tot = F1 * F2;
 
  document.getElementById("statistica_F").innerHTML = "<b>Statistica F =</b> "+ F_tot;  
  } 
}

function varianza(){  //sum(xi - media(x))^2 / n

  if(!trained)
    show();

  else{
    var n = data.length;
    var err = 0, sum = 0;

    for(var i = 0; i < n; i++) 
      sum =+ data[i];
 
    var mean = sum / n;

      for (var i = 0; i < n; i++) 
      err += Math.pow(data[i] - mean, 2);

    varX = err / n;
    document.getElementById("varianza").innerHTML = "<b>Varianza =</b> "+ varX;
  }
}

function covarianza(){   //sum [((yi - ym) * (xi -xm))/n ]

  if(!trained)
    show();

  else{
    var n = data.length;
    var sum_x = 0, sum_y = 0;


  for(var i = 0; i < n; i++){
    sum_x =+ data[i];
    sum_y =+ values[i];
  }

  var mean_x = sum_x / n,  mean_y = sum_y / n;
  var err_x = 0, err_y = 0;

  for(var i = 0; i < n; i++) 
    err_x =+ (data[i] - mean_x);

    for(var i = 0; i < n; i++) 
    err_y =+ (values[i] - mean_y);

    var den = err_y * err_x;
    var cov = den / n;

    document.getElementById("covarianza").innerHTML = "<b>Covarianza =</b> "+ cov;
  }
}
 
function show(){

  if (!trained) 
    document.getElementById("show").innerHTML = "<b>Mouse click add data point, then select and train your model :-)</b>"; 

  else{
    document.getElementById("show").innerHTML = "<b> RSE, RSS e MSE sono valori collegati fra loro, indicatori dello scarto fra i valori predetti rispetto a quelli reali." +
                                                " Molto utili per confrontare fra loro vari modelli, piu' sono bassi piu' il modello e' da ritenersi buono." + "<br/>" + "<br/>"+
                                                "Varianza, misura il grado di dispersione della variabile x."  + "<br/>" + "<br/>" +
                                                "Covarianza, indica il tipo di relazione presente fra le variabili x e y: piu' e' elevata e piu' il legame e' di tipo lineare. </b>";
  }
}

function setLearner(n){
  lrn=learners[n]
  trained=false
  train();
  sql();
  rse();
  rss();
  mse();
  r2();
  r2_adjusted();
  statistica_F();
  varianza();
  covarianza();
  show();
}

</script>


</body>
</html>
