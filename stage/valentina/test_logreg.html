<!doctype html>
<html>

  <head>
    <title>Classificazione</title>
  <link href="stile.css" rel="stylesheet" type="text/css">
  </head>

<body>
  <h1>Classificazione: Regressione Logistica, kernel Lineare, RBF e Polinomiale </h1>

  <div id=big_container>
  <span id=grafico>
  <canvas id="NPGcanvas" width="700" height="650" onclick="eventClick(event)">Browser not supported for Canvas. Get a real browser.</canvas>
  </span>

  <span id=destra>
  <p>Select your algorithms:</p>
  <div id="algo">
  <input id="button_regLog" type="button" value="Reg Logistica" onclick="setLearner(0)">
  <input id="button_kernel_Lin" type="button" value="Linear" onclick="setLearner(1)">
  <input id="button_RBF" type="button" value="RBF" onclick="setLearner(2)">
  <input id="button_kernel_pol2" type="button" value="Pol2" onclick="setLearner(3)">
  </div>

  <p>Select your actions:</p>
  <div id="azioni">
  <input id="button_train_clas" type="button" value="Train" onclick="train()">
  <input id="button_sql_clas" type="button" value="Sql" onclick="sql()">
  <input id="button_test" type="button" value="Data Test" onclick="data_test()">
  <input id="button_matrix_clas" type="button" value="Confusion Matrix" onclick = "conf_matrix()">
  <input id="button_prob" type="button" value="Prob(Y)" onclick="prob()">
  <input id="button_odds" type="button" value="Odds(Y)" onclick="odds()">
  <input id="button_goodMod" type="button" value="Efficenza Modello" onclick="goodMod()">
  </div>

  <div id="result_clas">
  <div id="info"></div>
  <div id="sql"></div>
  <div id="test"></div>
  <div id="confusion_matrix"></div>
  <div id="prob"></div>
  <div id="odds"></div>
  <div id="goodMod"></div>
  </div>

</div></span>
<input id="button_show_clas" type="button" value="Dettagli" onclick = "show()">
<div id="show"></div>
</div>

<script src="ZMLBase.js"></script>
<script src="ZMLLogisticRegression.js"></script>

<script src="svm.js"></script>
<script src="ZMLSvmClassifier.js"></script>


<script>

// variabili per la gestione del canvas
var canvas = document.getElementById("NPGcanvas")
var ctx = canvas.getContext('2d');
var WIDTH=700,HEIGHT=650,ss=50.0

// variabili per il learner
var data=[]       // valori delle x dei punti disegnati
var labels=[]     // valori delle classi dei punti disegnati
var trained=false

var test = [-1, 1, -1, 1, -1];

var learners=[new LogisticRegressionLearner(2), new LinearSvmLearner(2), new RbfSvmLearner(2), new Pol2SvmLearner(2)]
var lrn=learners[0]
var mdl=null

function addDataPoint(x,y,c){
  // add datapoint at location of click
  data.push([(x-WIDTH/2)/ss, (y-HEIGHT/2)/ss]);
  labels.push(c);
  trained=false
  Redraw()
}

function mouseClick(x,y,shift){
  addDataPoint(x,y,(shift?1:-1))
}

function eventClick(e) {    
  //get position of cursor relative to top left of canvas
  var x = e.pageX;
  var y = e.pageY;
  var r = canvas.getBoundingClientRect();
  x -= r.left+window.scrollX;
  y -= r.top+window.scrollY;  
  //call user-defined callback
  mouseClick(x, y, e.shiftKey);
}

function drawCircle(x, y, r){
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI*2, true); 
  ctx.closePath();
  ctx.stroke();
  ctx.fill();
}

function Redraw(){
  ctx.clearRect(0,0,WIDTH,HEIGHT);
  if (trained) {  
    // draw decisions in the grid
    var density= 4.0;
    for(var x=0.0; x<=WIDTH; x+= density) {
      for(var y=0.0; y<=HEIGHT; y+= density) {
        var p = mdl.predictJS([(x-WIDTH/2)/ss, (y-HEIGHT/2)/ss])
        ctx.fillStyle = (p==1?'rgb(255, 204, 153)': 'rgb(229, 204, 255)'); //colori della classificazione 
        /*ctx.fillStyle = 'rgb(255, 204, 153)';
        var rect = ctx.fillRect(0, 0, 50, 50);
        ctx.fillStyle = 'rgb(229, 204, 255)';
        var rect = ctx.fillRect(60, 0, 50, 50);*/
        ctx.fillRect(x-density/2-1, y-density-1, density+2, density+2);
      }
    }  
  }
  
  // draw axes
  ctx.beginPath();
  ctx.strokeStyle = 'rgb(50,50,50)';
  ctx.lineWidth = 1;
  ctx.moveTo(0, HEIGHT/2);
  ctx.lineTo(WIDTH, HEIGHT/2);
  ctx.moveTo(WIDTH/2, 0);
  ctx.lineTo(WIDTH/2, HEIGHT);
  ctx.stroke();
  // draw data points
  for(var i=0;i<data.length;i++){
    ctx.fillStyle = (labels[i]==1?'rgb(0, 153, 0)':'rgb(255, 0, 127)'); //colori punti
     /* ctx.fillStyle = 'rgb(0, 153, 0)';
      ctx.fillStyle = 'rgb(255, 0, 127)';*/
    drawCircle(data[i][0]*ss+WIDTH/2, data[i][1]*ss+HEIGHT/2, 3);
  }
}

Redraw()

function train(){
  lrn.resetData()
  for(var i=0;i<data.length;i++){
    lrn.addData(labels[i],data[i])
  }
  lrn.train()
  mdl=lrn.getModel()
  trained=true
  Redraw()
}

function sql(){
  if (trained){
    document.getElementById("sql").innerHTML=mdl.predictSQL(['CampoA','CampoB'])
  }
  show();
}

function data_test(){
 // for (var i = 0; i < test.length; i++)
 // document.getElementById("test").innerHTML = test[i] + " ";
 if (trained)
    document.getElementById("test").innerHTML = "<b>Dati di test = [-1, 1, -1, 1, -1]</b>";
  show();
}

function conf_matrix(){

  if(!trained)
    show();

  var tp = 0, tn = 0, fn = 0, fp = 0;
  //var n = data.length;
  var n = test.length;

  for (var i = 0; i < n; i++){

    //if (labels[i] == mdl.predictJS(data[i])){ // reali e predetti uguali  
    if (test[i] == mdl.predictJS(test[i])){ // reali e predetti uguali
        //if(labels[i] == 1) tp++;
        if(test[i] == 1) tp++;
        else tn++;
      }

      else{ // reali e predetti diversi
          //if(labels[i] == 1 && mdl.predictJS(test[i]) == -1) fn++;
          if(test[i] == 1 && mdl.predictJS(test[i]) == -1) fn++;
          else fp++;
      }
    }

    var acc = (tp + tn) / n;  
    var prec = tp / (tp + fp);
    var recall  =  tp / (tp + fn);
    var er_rate = (fp + fn) / n;  //ottimo = 0 , male = 1;
    var spec = tn / (tn + fp);  //ottimo = 1 , male = 0;
    var fp_rate = 1 - spec;  //ottimo = 0 , male = 1;
    var f_score = (2 * recall * prec) / (recall + prec); //ottimo = 1 , male = 0;

 document.getElementById("confusion_matrix").innerHTML = "<b>Confusion Matrix</b>" + "<br/>" +
                                                         "+ -------------------------------------- +  <br/>" + "<br/>" +
                                                         "<b>TRUE POSITIVE </b> " + tp + " " + "<b> FALSE NEGATIVE</b> "+ " " + fn + " <br/>" + " <br/>"+
                                                         "<b>FALSE POSITIVE</b> " + fp + " " + "<b>TRUE NEGATIVE</b> " + " " + tn + " <br/>" +  "<br/>" +
                                                         " + -------------------------------------- + " + "<br/>" + "<br/>" +
                                                         "<b>Error rate = </b>" + er_rate +  "<br/>" +  "<br/>" +
                                                         "<b>Accuratezza = </b>" + acc +  "<br/>" + "<br/>" +
                                                         "<b>Precisione = </b>" + prec +  "<br/>" + "<br/>" +
                                                         "<b>Recall = </b>" + recall +  "<br/>" + "<br/>" +
                                                         "<b>Specificita' = </b>" + spec +  "<br/>" + "<br/>" +
                                                         "<b>False Positive rate = </b>" + fp_rate +  "<br/>" + "<br/>" +
                                                         "<b>F - score = </b>" + f_score;

}                     

function prob(){

  if(!trained)
    show();

  //var n = data.length;
  var n = test.length, classeA = 0, classeB = 0;

  for (var i = 0; i < n; i++){
  //  if (labels[i] == 1) classeA++;
    if (test[i] == 1) classeA++;
    else classeB++;
  }
  //document.write(classeA + " " + classeB);

  var probA = (classeA / n) * 100;  //probabilita in % di appartenere alle classi -1 ed 1
  var probB = (classeB / n) * 100; 

  document.getElementById("prob").innerHTML = "<b>Prob (Y = 1): </b>" + probA + "% " + " ; " + " " +
                                              "<b> Prob (Y = -1): </b>" + probB + "% ";
}

function odds(){

  if(!trained)
    show();

  //var n = data.length;
  var n = test.length, classeA = 0, classeB = 0;

for (var i = 0; i < n; i++){
 // if (labels[i] == 1) classeA++;
 if (test[i] == 1) classeA++;
  classeB++;
}
//document.write(classeA + " " + classeB);

var oddsA =  classeA / classeB; // odds: relazione fra A e B
var oddsB =  classeB / classeA;  // odds: relazione fra B ed A

document.getElementById("odds").innerHTML = "<b>Odds (Y = 1): </b>" + oddsA + " ; " +
                                            "<b> Odds (Y = -1): </b>" + oddsB;

}

function goodMod(){ //efficienza predittiva = (er. senza mod - er. col mod) / er. senza mod
                    // er. senza mod = sum [fi * ((n - fi) / n) ]  ,  dove   fi = n. casi in i
  if(!trained)
    show();

 // var n = data.length;
  var n = test.length, err = 0;

  for (var i = 0; i < n; i++){
      
    //if (labels[i] != mdl.predictJS(data[i])) // reali e predetti diversi -> errori col modello
    if (test[i] != mdl.predictJS(test[i])) // reali e predetti diversi -> errori col modello
       err++; 
  }

  //err. senza modello
  var fi = 0;

  for (var i = 0; i < n; i++){
    //if (labels[i] == -1) fi++;
    if (test[i] == -1) fi++;
  }
   // document.write(fi);

    var er_NoMod = fi * [(n - fi) / n];
   //document.write(er_NoMod);

    var good = (er_NoMod - err) / er_NoMod;

    document.getElementById("goodMod").innerHTML = "<b> Efficienza del modello = </b> " + good;
}

function show(){

  if (!trained) 
    document.getElementById("show").innerHTML = "<b>Mouse click add data point, then select and train your model :-)</b>";

  else{
    document.getElementById("show").innerHTML = "<b>Prob(Y) e Odds(Y) esprimono entrambi la probabilita' del verificarsi di un determinato evento" +
                                                ": semplicemente cambia il modo in cui lo fanno. Mentre il primo e' il tradizionale rapporto fra il n. di occorrenze" +
                                                " dell'evento col n. totale di osservazioni; il secondo si esprimere mediante il rapporto fra i " +
                                                " due eventi stessi: classeA / classeB (o viceversa in base all'oggetto della previsione)." + "<br/>" + "<br/>" +
                                                "L'efficienza del modello permette di dare una valutazione circa il modello di classificazione." +  
                                                " Tale misurazione  si basa sulla valutazione della riduzione dell’errore in percentuale : " + "<br/>" + "<br>" +
                                                " errore senza modello + errore col modello " + "<br/>" +
                                                " ---------------------------------------------------" + "</br>"+ 
                                                "errore senza modello"
  }
}

function setLearner(n){
  lrn=learners[n]
  trained=false;
  train();
  sql();
  data_test();
  conf_matrix();
  prob();
  odds();
  goodMod();
  show();
}

</script>


</body>
</html>